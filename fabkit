#!/usr/bin/env bash

source $(pwd)/.env
for f in ./scripts/*; do source $f; done
# Auto Complete
source ./scripts/bash_autocomplete.sh
AutoComplete

export GO111MODULE=on
export GOPRIVATE=bitbucket.org/everledger/*

# name of the working directory/project
export WORKSPACE=$(basename ${ROOT})
# it should be under GOPATH (automatically added in front of this path)
# TODO: Set a default chaincode path and grab the name of the package instead
export CHAINCODE_REMOTE_PATH=bitbucket.org/everledger/${WORKSPACE}/chaincode

readonly ONE_ORG="OneOrgOrdererGenesis"
readonly TWO_ORGS="TwoOrgsOrdererGenesis"
readonly THREE_ORGS="ThreeOrgsOrdererGenesis"
readonly RAFT_ONE_ORG="OneOrgOrdererEtcdRaft"

# DO NOT REMOVE
# docker exec command
PEER_EXEC=""

__yq() {
    docker run --rm -i -v "${PWD}":/workdir ${YQ_DOCKER_IMAGE} yq "$@"
}

__jq() {
    docker run --rm -i -v "${PWD}":/workdir ${JQ_DOCKER_IMAGE} "$@"
}

__log_setup() {
    log "Setup" info
    echo
    log "FABRIC_VERSION=${FABRIC_VERSION}" info
    log "ORGS=${ORGS:-1}" info
    log "CI=${CI:-false}" info
    log "DEBUG=${DEBUG:-false}" info
    log "RESET=${RESET:-false}" info
    echo
}

__set_params() {
    while [[ $# -gt 0 ]]; do
        param="${1}"

        case $param in
        -c|--ci)
            CI=true
            shift
            ;;
        -d|--debug)
            DEBUG=true
            shift
            ;;
        -r|--reset)
            RESET=true
            shift
            ;;
        -o|--orgs)
            ORGS="${2}"
            shift 2
            ;;
        -v|--version)
            FABRIC_VERSION="${2}"
            shift 2
            ;;
        *) 
            log "${1} paramater not recognized. Please run the help." error
            exit 1
            ;;
        esac
    done
}

readonly func="$1"
shift

if [ "$func" == "network" ]; then
    __check_deps deploy
    __check_docker_daemon
    param="$1"
    shift
    if [ "$param" == "install" ]; then
        install_network
    elif [ "$param" == "start" ]; then
        __set_params "$@"
        __log_setup
        start_network "$@"
    elif [ "$param" == "restart" ]; then
        restart_network
    elif [ "$param" == "stop" ]; then
        stop_network
    else
        help
        exit 1
    fi
elif [ "$func" == "explorer" ]; then
    __check_deps deploy
    __check_docker_daemon
    param="$1"
    shift
    if [ "$param" == "start" ]; then
        start_explorer
    elif [ "$param" == "stop" ]; then
        stop_explorer
    else
        help
        exit 1
    fi
elif [ "$func" == "dep" ]; then
    param="$1"
    shift
    if [ "$param" == "install" ]; then
        dep_install "$@"
    elif [ "$param" == "update" ]; then
        dep_update "$@"
    else
        help
        exit 1
    fi
elif [ "$func" == "chaincode" ]; then
    param="$1"
    shift
    if [ "$param" == "lifecycle" ]; then
        __check_fabric_version 2
        param="$1"
        shift
        if [ "$param" == "package" ]; then
            __check_deps deploy
            __check_docker_daemon
            lc_chaincode_package "$@"
        elif [ "$param" == "install" ]; then
            __check_deps deploy
            __check_docker_daemon
            lc_chaincode_install "$@"
        elif [ "$param" == "approve" ]; then
            __check_deps deploy
            __check_docker_daemon
            lc_chaincode_approve "$@"
        elif [ "$param" == "commit" ]; then
            __check_deps deploy
            __check_docker_daemon
            lc_chaincode_commit "$@"
        elif [ "$param" == "deploy" ]; then
            __check_deps deploy
            __check_docker_daemon
            lc_chaincode_deploy "$@"
        else
            help
            exit 1
        fi
    elif [ "$param" == "install" ]; then
        __check_fabric_version 1
        __check_deps deploy
        __check_docker_daemon
        chaincode_install "$@"
    elif [ "$param" == "instantiate" ]; then
        __check_fabric_version 1
        __check_deps deploy
        __check_docker_daemon
        chaincode_instantiate "$@"
    elif [ "$param" == "upgrade" ]; then
        __check_fabric_version 1
        __check_deps deploy
        __check_docker_daemon
        chaincode_upgrade "$@"
    elif [ "$param" == "test" ]; then
        chaincode_test "$@"
    elif [ "$param" == "build" ]; then
        chaincode_build "$@"
    elif [ "$param" == "package" ]; then
        __check_fabric_version 1
        __check_deps deploy
        __check_docker_daemon
        chaincode_pack "$@"
    elif [ "$param" == "zip" ]; then
        chaincode_zip "$@"
    elif [ "$param" == "query" ]; then
        __check_deps deploy
        __check_docker_daemon
        query "$@"
    elif [ "$param" == "invoke" ]; then
        __check_deps deploy
        __check_docker_daemon
        invoke "$@"
    else
        help
        exit 1
    fi
elif [ "$func" == "generate" ]; then
    __check_deps deploy
    __check_docker_daemon
    param="$1"
    shift
    if [ "$param" == "cryptos" ]; then
        generate_cryptos "$@"
    elif [ "$param" == "genesis" ]; then
        generate_genesis "$@"
    elif [ "$param" == "channeltx" ]; then
        generate_channeltx "$@"
    else
        help
        exit 1
    fi
elif [ "$func" == "ca" ]; then
    __check_deps deploy
    __check_docker_daemon
    param="$1"
    shift
    if [ "$param" == "register" ]; then
        register_user "$@"
    elif [ "$param" == "enroll" ]; then
        __check_deps deploy
        enroll_user "$@"
    elif [ "$param" == "reenroll" ]; then
        reenroll_user "$@"
    elif [ "$param" == "revoke" ]; then
        revoke_user "$@"
    else
        help
        exit 1
    fi
elif [ "$func" == "channel" ]; then
    __check_deps deploy
    __check_docker_daemon
    param="$1"
    shift
    if [ "$param" == "create" ]; then
        create_channel "$@"
    elif [ "$param" == "update" ]; then
        update_channel "$@"
    elif [ "$param" == "join" ]; then
        join_channel "$@"
    else
        help
        exit 1
    fi
elif [ "$func" == "benchmark" ]; then
    param="$1"
    shift
    if [ "$param" == "load" ]; then
        __check_deps deploy
        __exec_jobs "$@"
    else
        help
        exit 1
    fi
elif [ "$func" == "utils" ]; then
    param="$1"
    shift
    if [ "$param" == "tostring" ]; then
        tostring "$@"
    elif [ "$param" == "tojson" ]; then
        tojson "$@"
    else
        help
        exit 1
    fi
else
    help
    exit 1
fi